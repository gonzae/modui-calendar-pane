/*
 * Backbone.Courier, v1.0.0
 * Copyright (c)2013 Rotunda Software, LLC.
 * Distributed under MIT license
 * http://github.com/rotundasoftware/backbone.courier
*/
(function(e,n){"function"==typeof define&&define.amd?define(["underscore","backbone","jquery"],n):"undefined"!=typeof exports?module.exports=n(require("underscore"),require("backbone"),require("backbone").$):n(e._,e.Backbone,e.jQuery||e.Zepto||e.$)})(this,function(e,n,t){var r=/^(\S+)\s*(.*)$/,a=e.isFunction(t)?t("body")[0]:null;return n.Courier={},n.Courier.add=function(t){function i(n){e.isFunction(n.$el.data)&&!n.$el.data("view")&&n.$el.data("view",n)}function s(n,t,a){var i=[];for(var s in n){var o=s.match(r),u=o[1],l=o[2],d=RegExp(u.replace("*","[\\w]*"));d.test(t.name)&&(""===l||a._getChildViewNamed(l)===t.source)&&i.push({eventName:u,subviewName:l,value:n[s]})}return i.length>1&&(i=e.sortBy(i,function(e){var n=e.eventName.replace("*",""),t=""!==e.subviewName,r=(t?1e3:0)+n.length;return-r})),i.length?i[0].value:null}var o={setElement:t.setElement};t.spawn=function(n,r){if(e.isString(n))n={name:n,data:r};else if(e.isUndefined(n.name))throw Error("Undefined message name.");n.source=t,n.data=n.data||{},this.trigger(n.name,n.data);for(var a,i,o="!"===n.name[n.name.length-1],u=this._getParentView();u;){if(e.isObject(u.onMessages)&&(i=s(u.onMessages,n,u),null!==i)){var l=i;if(e.isFunction(l)||(l=u[i]),!l)throw Error('Method "'+i+'" does not exist');var d=l.call(u,n.data,n.source,n.name);if(o)return d}a=!1;var f=e.result(u,"passMessages");if(e.isObject(f))if(i=s(f,n,u),null!==i){if("."===i);else{if(!e.isString(i))throw new TypeError("Values of passMessages hash should be strings.");n.name=i}a=!0}else o&&(a=!0);if(o&&(a=!0),!a)break;n.source=u,u=u._getParentView()}if(o)throw Error('Round trip message "'+n.name+'" was not handled. All round trip messages must be handled.')},e.isFunction(t._getParentView)||(t._getParentView=function(){for(var e=null,t=this.$el.parent();t.length>0&&t[0]!==a;){var r=t.data("view");if(r&&r instanceof n.View){e=r;break}t=t.parent()}return e}),e.isFunction(t._getChildViewNamed)||(t._getChildViewNamed=function(n){return e.isObject(this.subviews)?this.subviews[n]:null}),t.setElement=function(e,n){var r=o.setElement.call(this,e,n);return i(t),r},t.$el&&i(t)},n.Courier});